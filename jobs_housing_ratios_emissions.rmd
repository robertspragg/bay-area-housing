---
title: "Housing Jobs Mismatch and Associated Emissions Impacts"
author: "Robert Spragg"
date: 2020-01-19
output: 
  github_document:
    toc: true
---

```{r include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include = FALSE}
## LIBRARIES
library(knitr)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
```

```{r include = FALSE}

county_bound_path <-
  "county_bounds"
# source: https://geodata.lib.berkeley.edu/catalog/ark28722-s7vp4m

city_bound_path <-
  "places_bounds"
# source: https://data.ca.gov/dataset/ca-geographic-boundaries

ca_county <-
  read_sf(county_bound_path) %>% 
  st_transform(crs = 4326)

ca_cities <-
  read_sf(city_bound_path) %>% 
  st_transform(crs = 4326)

bay_area_counties <-
  c("Alameda", "Contra Costa", "Marin", "Merced", 
    "Napa", "San Benito", "San Francisco", 
    "San Joaquin", "San Mateo", "Santa Clara",
    "Santa Cruz", "Solano", "Sonoma", 
    "Stanislaus"
  )
```


```{r include = FALSE}
## MTC DATA
mtc_taz_shp <-
  "mtc"
mtc_taz_jobs <-
  "mtc/Plan_Bay_Area_2040_Forecast__Employment.csv"
mtc_taz_land_use <-
  "mtc/Plan_Bay_Area_2040_Forecast__Land_Use_and_Transportation.csv"
mtc_taz_pop <-
  "mtc/Plan_Bay_Area_2040_Forecast__Population_and_Demographics.csv"

# 4. Simplified commute data file 
# Source: https://www.kaggle.com/figshare/united-states-commutes/version/1 
bay_area_commute_path <-
  "commutes/bay_area_commute_data.csv"

# 5. Census tract csv file (from kaggle as well)
census_tracts_bay_area <-
  "census_data/bay_area_census_tract_data.csv"

```


## Abstract
This report is split into two main sections.

In the first section, spatial data from Caltrans and the Metropolitan Transportation Commission is
utilized to estimate the population, number of jobs, number of housing units,
and number of households in each Bay Area city. Variations in the ratio of jobs
to housing units across cities and counties are explored, and the most imbalanced
regions are identified. Next, the total shortage of housing units in the Bay Area
is estimated, and the housing deficit is calculated for each city.

In the second section, census data is utilized to observe commutes to regions with a
high ratio of jobs to housing units. 
The average commute distance to San Francisco, as well as to each city in 
San Mateo and Santa Clara counties, is estimated and compared to the commuting distance of residents
of the three counties. Finally, the additional vehicle-miles traveled and carbon
emissions caused by the housing imbalance of these three regions is estimated.

## Introduction

Currently, the Bay Area faces an extreme housing shortage, rapidly increasing 
rents, and ever-worsening commute times. Since 1990, the Bay Area has added
two jobs for each housing unit.[^1] Most of the housing units that 
have been built are far from job centers, which has caused carbon dioxide
emissions from the transportation sector to increase. Transportation sector
emissions are now the largest source of emissions in California at over 40%.[^1]
The lack of housing options has forced many residents into extremely long commutes
from the Central Valley. This has become so commonplace that the San Jose - 
San Francisco - Oakland Combined Statistical Area (CSA) was modified to include
Stanislaus and Merced counties in September 2018.[^2]

There are multiple reasons for the housing crisis, including but not limited to:
exclusionary zoning practices, a booming tech economy, apartment bans, 
the lengthy public approval process for new infill developments, litigation 
involving the California Environmental Quality Act (CEQA), Proposition 13, 
and the region's unique topography.

## Related Work

I have previously written an article titled 'Decarbonization and Density go 
Hand in Hand', which explains the current state of housing policy in California,
and how changing our land use patterns could enable more rapid decarbonization
of the buildings and transportation sectors.[^3]. Many other authors have written
about the housing crisis. The Public Policy Institute of California found that
"restrictive zoning and planning regulations can depress housing supply and 
increase housing costs."[^3] Finally, Governor Newsom has voiced his support
for a radical paradigm shift in California by advocating for the construction of
3.5 million new homes in California by 2025.[^4] This equates to a housing growth
rate that is more than 5 times faster than what California has experienced during
the past decade. 

## Datasets

1. The Metropolitan Transportation Commission (MTC) maintains a dataset that contains
employment, households, land use, and population data for 1454 Transportation
Analysis Zones (TAZs) for the nine-country region.[^5] Historical data from 2005, 2010, and 2015,
as well as future forecasts to 2040, in five-year intervals, are available. 

2. Caltrans maintains a spatial file which has the city boundaries of every city in
California.

3. Stanford maintains an online GIS repository called EarthWorks. From this site,
county shapefiles for the nine-county Bay Area region were utilized.[^4] 

4. A study from Nelson & Rae utilized American Community Survey's commuting and 
workplace dataset.[^6] This dataset provides census-tract level information
on the origin and destination of commute trips.

5. Census tract data for each county was found on various county Open Data platforms.[^5]

## Methods: Part 1

The Caltrans city limits dataset, along with the county shapefile boundaries,
appears as follows.

```{r}
# Filter for counties in the 14 county Bay Area CSA
csa_counties <-
  ca_county %>% 
  filter(COUNTY %in% bay_area_counties)

# Join with all counties and then filter to avoid putting cities in wrong county
csa_cities <-
  ca_cities %>% 
  st_join(ca_county, largest = TRUE) %>% 
  filter(COUNTY %in% bay_area_counties)

# Remove portion of polygon that is over water in Ocean / SF Bay
csa_cities_cleaned <-
  st_intersection(csa_counties, csa_cities %>% st_transform(crs = 4326))
```

```{r}
# Plot of communities in the 14-county region
ggplot() +
  geom_sf(data = csa_counties) +
  geom_sf(
    aes(fill = COUNTY),
    data = csa_cities_cleaned
  ) +
  theme(legend.position = "none") +
  theme_minimal() +
  labs(
    subtitle = "Colored regions represent communities (both incorporated and unincorporated)",
    fill = "County"
  )
```

The MTC data file has the following non-spatial components for each TAZ
(first 5 rows are shown, out of 1454).

We load the columns from each file of interest. Remember to check
the `crs` of the spatial file.
```{r}
## SPATIAL FILE
mtc_taz <-
  read_sf(dsn = mtc_taz_shp)

st_crs(mtc_taz)
```

```{r}
mtc_jobs <-
  read_csv(mtc_taz_jobs,
    col_types = 
      cols_only(
        totemp05 = col_integer(),
        totemp15 = col_integer(),
        totemp30 = col_integer(),
        zoneid = col_integer()
      )
  )  
  
mtc_housing <-
  read_csv(
    mtc_taz_land_use,
    col_types = 
      cols_only(
        sfdu05 = col_integer(),
        mfdu05 = col_integer(),
        sfdu15 = col_integer(),
        mfdu15 = col_integer(),
        sfdu30 = col_integer(),
        mfdu30 = col_integer(),
        zoneid = col_integer()
      )
  ) 

mtc_pop <-
  read_csv(
    mtc_taz_pop,
    col_types = 
      cols_only(
        totpop05 = col_integer(),
        totpop15 = col_integer(),
        totpop30 = col_integer(),
        zoneid = col_integer()
      )
  )
```

Next, join each TAZ data file with the TAZ spatial data.

```{r}
taz_all <-
  mtc_taz %>% 
  left_join(mtc_jobs, by = c("taz1454" = "zoneid")) %>% 
  left_join(mtc_housing, by = c("taz1454" = "zoneid")) %>% 
  left_join(mtc_pop, by = c("taz1454" = "zoneid"))
```

Let's preview the data (excluding the geometry).
`totemp` refers to the total number of jobs (2005 and 2015 actuals, 2030 forecast) for each TAZ.

`sfdu` and `mfdu` refer to single-family and multi-family dwelling units, respectively.

`totpop` refers to the population for each TAZ.

```{r}
taz_all %>% st_drop_geometry() %>% 
  slice(1:5) %>% 
  kable()
```

The MTC spatial data, overlaid on the 9-county region, appears as follows.
```{r}
taz_all %>% 
  ggplot() +
  geom_sf(aes(fill = county, color = NULL), alpha = 0.6) +
  geom_sf(data = csa_counties, color = "black", size = 1, alpha = 0) +  
  theme_minimal() +
  labs(
    fill = "County"
  )
```

Each TAZ is in only one county. We are interested in knowing information 
for each city, but our data is currently defined by the TAZs. Therefore, we join 
each TAZ with a single city. The `largest = TRUE` argument is used in `st_join`
to match each TAZ to the city that it lies in the most. Let's observe the join
results for San Mateo, Santa Clara, Alameda, and Contra Costa counties to make sure
the results are accurate.

There are two TAZs that joined to a city in another county (1044 and 297). This 
occurred when the city limit bordered the county line adjacent to a TAZ in the
other county that was not within any city in its respective county. For these zones, 
the city value is set to `NA`.

```{r}
mtc_city_joined <-
  taz_all %>% 
  st_join(csa_cities_cleaned, largest = TRUE) %>% 
  mutate(NAME = if_else(county != COUNTY, NA_character_, NAME))

```

San Mateo County
```{r}
mtc_city_joined %>% 
  filter(county %in% c("San Mateo")) %>% 
  ggplot() +
  geom_sf(aes(fill = NAME)) +
  geom_sf(
    data = csa_cities_cleaned %>% filter(COUNTY == "San Mateo"), 
    fill = NA,
    color = "black",
    size = 1
  ) +
  coord_sf(
    ylim = c(37.3, 37.75)
  ) +
  theme_minimal() +
  labs(
    fill = "City"
  )
```

Santa Clara County (code suppressed)
```{r echo = FALSE}
mtc_city_joined %>% 
  filter(county %in% c("Santa Clara")) %>% 
  ggplot() +
  geom_sf(aes(fill = NAME)) +
  geom_sf(
    data = csa_cities_cleaned %>% filter(COUNTY == "Santa Clara"), 
    fill = NA,
    color = "black",
    size = 1
  ) +
  theme_minimal() +
  labs(
    fill = "City/Place"
  )  
```

Check the population of the largest TAZs in Santa Clara County
```{r}
mtc_city_joined %>% 
  filter(county %in% c("Santa Clara")) %>% 
  arrange(-gacres)
```

Alameda County (code suppressed)
```{r echo = FALSE}
mtc_city_joined %>% 
  filter(county %in% c("Alameda")) %>% 
  ggplot() +
  geom_sf(aes(fill = NAME)) +
  geom_sf(
    data = csa_cities_cleaned %>% filter(COUNTY == "Alameda"), 
    fill = NA,
    color = "black",
    size = 1
  ) +
  theme_minimal() +
  labs(
    fill = "City"
  )  
```


Contra Costa County (code suppressed)
```{r, echo = FALSE, fig.height=4}
mtc_city_joined %>% 
  filter(county %in% c("Contra Costa")) %>% 
  ggplot() +
  geom_sf(aes(fill = NAME)) +
  geom_sf(
    data = csa_cities_cleaned %>% filter(COUNTY == "Contra Costa"), 
    fill = NA,
    color = "black",
    size = 1
  ) +
  theme_minimal() +
  labs(
    fill = "City"
  )  
```

In densely populated areas, the merging does a great job of mapping the TAZs 
to cities. The only densely populated area that is not matched to a city is 
in Alameda county. This region corresponds to Castro Valley (which apparently is unincorporated!).

**Calculating the Ratio of Housing to Jobs**

Now that the MTC spatial, housing, and jobs data is merged with the city limit
spatial data, we now know *approximately* which zones correspond to which city. 

Many recent news articles have focused on the lack of new housing in the Bay Area. [^8]
Let's see if their worries are accurate.

For each city, we will calculate the ratio of jobs per housing unit for 2005, 2015,
and 2030. Both single-family and multi-family housing units are included.

```{r}
jobs_housing_ratios <-
  mtc_city_joined %>% 
  select_at(
    vars(matches("(NAME)|(county)|(sfdu)|(mfdu)|(totemp)|(totpop)"))
  ) %>% 
  select(-county) %>% 
  rename_all(str_to_lower) %>% 
  group_by(name, county) %>% 
  summarize(
    city_pop_05 = sum(totpop05),
    city_pop_15 = sum(totpop15),
    city_pop_30 = sum(totpop30),
    job_house_05 = sum(totemp05) / (sum(sfdu05) + sum(mfdu05)),
    job_house_15 = sum(totemp15) / (sum(sfdu15) + sum(mfdu15)),
    job_house_30 = sum(totemp30) / (sum(sfdu30) + sum(mfdu30)),
    city_units_05 = sum(sfdu05) + sum(mfdu05),
    city_units_15 = sum(sfdu15) + sum(mfdu15),
    city_units_30 = sum(sfdu30) + sum(mfdu30)
  ) %>% 
  ungroup()

mtc_city_joined %>% st_drop_geometry() %>% 
  summarize(
    jobs_added = sum(totemp15) - sum(totemp05),
    units_added = sum(sfdu15) + sum(mfdu15) - sum(sfdu05) - sum(mfdu05),
    ratio = jobs_added / units_added
  )

mtc_city_joined %>% st_drop_geometry() %>% filter(county == "San Francisco") %>% 
  summarize(
    jobs_added = sum(totemp15) - sum(totemp05),
    units_added = sum(sfdu15) + sum(mfdu15) - sum(sfdu05) - sum(mfdu05),
    ratio = jobs_added / units_added
  )

```
Between 2005 and 2015, the Bay Area as a whole added approximately 1.4 jobs
for each housing unit built. However, San Francisco added approximately **2.6** jobs
for each housing unit during the same time period. It is also important to note
that the Great Recession depressed employment numbers during this period.

**What is the ideal housing-jobs ratio?**

In order for a city to be a place where people can both live and work, there must
be both housing units and employment opportunities. However, the ideal ratio of jobs
to housing is definitely undecided. Some authors have 
suggested that 1.5 is the highest value before traffic is severely impacted
(Cevero 1989). Others list optimal values between 1.0 and 1.25 (Margolis, 1957).

**Visualizing the Housing-Jobs Mismatch**

I began by plotting the 2005, 2015, and 2030 ratios of jobs to housing units 
for each Bay Area city. The cities are ordered from highest to lowest ratio 
in 2015. The Southern California Association of Governments established a 
target ratio of jobs to housing untis of 1.25. Therefore, we will use 1.25 as 
our target ratio for the Bay Area.

```{r}
jobs_housing_ratios %>% 
  filter(city_pop_15 >= 5000, job_house_15 > 0.8, name == "Stanford") %>% 
  arrange(job_house_15)
```



Figure showing 2015 jobs-housing ratios
```{r, fig.height = 10}
jobs_housing_ratios %>% 
  filter(job_house_15 > 0.9, city_pop_15 > 4000) %>% 
  ggplot() +
  geom_point(aes(x = job_house_15, y = reorder(name, job_house_15), size = city_pop_15), shape = 21, fill = "red") +
  geom_vline(xintercept = 1.25, linetype = "dashed", color = "black", size = 1) +
  annotate("text", x = 4, y = 77.2, label = "Stanford: 11.6 →", color = "red", fontface = "bold") +
  annotate("text", x = 1.6, y = 77.7, label = "Optimal value: 1.25") +
  scale_x_continuous(breaks = seq(0.5, 5, 0.5)) +
  scale_size_continuous(
    breaks = c(1000000, 400000, 200000, 50000, 5000),
    labels = scales::comma_format(accuracy = 1),
    range = c(1, 7)
  ) +
  coord_cartesian(xlim = c(0.5, 4.5), ylim = c(0, 78)) +
  theme_bw() +
  labs(
    x = "Jobs per housing unit",
    y = "City Name",
    title = "The distribution of job-housing ratios across the Bay Area (2015)",
    subtitle = "Communities with population greater than 4,000 and jobs-housing ratio greater than 0.9",
    size = "City Population"
  )
```

Figure showing 2015 and 2030 jobs-housing ratios
```{r, fig.height = 10}
jobs_housing_ratios %>% 
  filter(job_house_15 > 0.9, city_pop_15 > 4000) %>% 
  ggplot() +
  geom_point(aes(x = job_house_15, y = reorder(name, job_house_15), size = city_pop_15), shape = 21, fill = "red") +
  geom_point(aes(x = job_house_30, y = name, size = city_pop_30), shape = 21, fill = "blue") +
  geom_segment(aes(x = job_house_15, y = name, xend = job_house_30, yend = name)) +
  geom_vline(xintercept = 1.25, linetype = "dashed", color = "black", size = 1) +
  annotate("text", x = 4, y = 77.2, label = "Stanford: 11.6 →", color = "red", fontface = "bold") +
  annotate("text", x = 1.6, y = 77.7, label = "Optimal value: 1.25", fontface = "bold") +
  scale_x_continuous(breaks = seq(0.5, 5, 0.5)) +
  scale_size_continuous(
    breaks = c(1000000, 400000, 200000, 50000, 5000),
    labels = scales::comma_format(accuracy = 1),
    range = c(1, 7)
  ) +
  coord_cartesian(xlim = c(0.5, 4.5), ylim = c(0, 78)) +
  theme_bw() +
  labs(
    x = "Jobs per housing unit",
    y = "City Name",
    title = "The distribution of job-housing ratios across the Bay Area: 2015 (red) and 2030 (blue)",
    subtitle = "Communities with population greater than 4,000 and jobs-housing ratio greater than 0.9",
    size = "City Population"
  )
```

One can also facet by county to see if any county-specific trends appear.

```{r, fig.height = 15}
jobs_housing_ratios %>% 
  mutate(name = fct_reorder(name, job_house_15)) %>%  
  filter(city_pop_15 >= 4000) %>% 
  ggplot() +
  geom_segment(aes(x = job_house_05, y = name, xend = job_house_15, yend = name)) +
  geom_segment(aes(x = job_house_15, y = name, xend = job_house_30, yend = name)) +
  geom_vline(xintercept = 1.25, linetype = "dashed", color = "black", size = 1) +  
  geom_point(aes(x = job_house_05, y = name, size = city_pop_05), shape = 21, fill = "yellow") +
  geom_point(aes(x = job_house_15, y = name, size = city_pop_15), shape = 21, fill = "red") +
  geom_point(aes(x = job_house_30, y = name, size = city_pop_30), shape = 21, fill = "blue") +
  facet_grid(rows = vars(county), scales = "free", space = "free") +
  scale_size_continuous(
    breaks = c(1000000, 300000, 100000, 50000, 5000),
    labels = scales::comma_format(accuracy = 1)
  ) +
  theme(
    axis.text.y = element_text(size = 6)
  ) +
  labs(
    x = "Jobs per housing unit",
    y = "City Name",
    size = "City Population",
    title = "Bay Area jobs-housing ratios, faceted by county",
    subtitle = "Data sorted by 2015 jobs-housing ratio \nYellow = 2005; Red = 2015; Blue = 2030",
    size = "City Population"    
  )
```

Every county (except San Francisco, which is both a city and a county) has a wide array of job-housing ratios
within its boundaries. It appears as though most counties have cities that are
job centers as well as cities that act as suburbs and or bedroom communities.
Let's calculate the county-wide averages for 2005, 2015,
and 2030, weighted by the number of housing units during each time period in 
each city.

```{r}
jobs_housing_ratios %>% 
  group_by(county) %>% 
  summarize(
    avg_ratio_05 = weighted.mean(job_house_05, city_units_05),
    avg_ratio_15 = weighted.mean(job_house_15, city_units_15),
    avg_ratio_30 = weighted.mean(job_house_30, city_units_30)
  ) %>% 
  gather(key = "year", value = "ratio", avg_ratio_05:avg_ratio_30) %>% 
  ggplot(aes(x = year, y = ratio)) +
  geom_hline(yintercept = 1.25, linetype = "dashed", color = "black", size = 1) +
  geom_line(aes(group = county, color = county), size = 0.8) +
  geom_point(aes(color = county)) +
  theme_minimal() +
  scale_x_discrete(
    labels = c("2005", "2015", "2030")
  ) +
  labs(
    x = "Year",
    y = "Average jobs per housing unit",
    color = "County",
    subtitle = "Optimal value: 1.25 jobs per housing unit"
  )
```

We can also find the average for the entire 9-county region for the three periods.

```{r}
jobs_housing_ratios %>% st_drop_geometry() %>% 
  summarize(
    avg_ratio_05 = weighted.mean(job_house_05, city_units_05),
    avg_ratio_15 = weighted.mean(job_house_15, city_units_15),
    avg_ratio_30 = weighted.mean(job_house_30, city_units_30)    
  ) %>% 
  pull(avg_ratio_15)
```

Let's see who is contributing the most to the region's housing deficit. The deficit
is calculated as the additional housing supply in 2015 needed to provide a 1.25 ratio
of jobs (2015 data) to housing units.
```{r}
deficit <-
  jobs_housing_ratios %>% 
  # filter(job_house_15 >= 1.25) %>% 
  mutate(
    housing_deficit = round(city_units_15 * job_house_15 / 1.25 - city_units_15),
    existing_units = city_units_15,
    growth = housing_deficit / city_units_15 * 100
  ) %>% 
  arrange(-housing_deficit) %>% 
  select(name, housing_deficit, existing_units, growth)

deficit %>% 
  st_drop_geometry() %>% 
  slice(1:10) %>% 
  kable()

deficit
```

San Francisco, Palo Alto, Santa Clara, and Berkeley have the highest housing deficits.
Let's also look at the opposite end of the spectrum to see which communities could use 
more jobs.

```{r}
deficit_jobs <-
  jobs_housing_ratios %>% 
  filter(job_house_15 < 1.25) %>% 
  mutate(housing_surplus = round(city_units_15 * job_house_15 / 1.25 - city_units_15)) %>% 
  arrange(housing_surplus) %>% 
  select(name, housing_surplus)

deficit_jobs %>% st_drop_geometry() %>% 
  mutate(housing_surplus = -1 * housing_surplus) %>% 
  rename(Name = name, `Housing Surplus` = housing_surplus) %>% 
  slice(1:10) %>% 
  kable()
```

Unincorporated, rural regions tend to have more housing units than jobs. 
Cities with a notable lack of jobs include Daly City as well as the far-flung 
suburbs of Vallejo, Antioch, Brentwood, and Pittsburg.

Let's create a spatial visualization of the housing shortage.

```{r, fig.height = 8}
NYT_DEM <- "#1A80C4"
NYT_REP <- "#CC3D41"
light_red <- "#FDB8A9"
dark_red <- "#9C2A12"

deficit %>% 
  ggplot() +
  geom_sf(aes(fill = NULL), data = csa_counties) +
  geom_sf(aes(fill = NULL), color = "black", data = csa_cities_cleaned) +
  geom_sf(aes(fill = housing_deficit), data = deficit) +
  geom_sf(aes(fill = housing_surplus), data = deficit_jobs) +
  coord_sf(ylim = c(36.89, 38.3),
           xlim = c(-121.2, -122.6)) +
  scale_fill_gradientn(
    breaks = seq(-10000, 180000, 30000),
    labels = scales::comma_format(accuracy = 1, suffix = " units"),
    colors = c(NYT_DEM, "white", light_red, NYT_REP, dark_red),
    values = c(-10000, 0, 5000, 50000, 100000) %>% 
      scales::rescale()
  ) +
  theme_minimal() +
  labs(
    fill = "Housing Deficit / Surplus \n(No. Units)",
    title = "San Francisco's housing deficit is by far the largest contributor to the region's shortage",
    subtitle = "Outside of SF, Silicon Valley communities tend to have the largest housing deficits"
  )
```

Finally, let's see the total imbalace caused by cities with a high jobs-housing
ratio, and the deficit for the Bay Area as a whole.

```{r}
deficit %>% 
  filter(housing_deficit > 0) %>% 
  summarize(
    total_imbalance = sum(housing_deficit, na.rm = TRUE)
  ) %>% 
  pull(total_imbalance)
```

```{r}
mtc_city_joined %>% st_drop_geometry() %>% 
  summarize(
    regional_shortage = sum(totemp15) / 1.25 - (sum(sfdu15) + sum(mfdu15))
  ) %>% 
  pull()
```

As of 2015, the Bay Area needed around **310,000 housing units** to meet its
housing needs. Given that the region's rapid employment growth has not slowed,
this value is likely higher now.

## Methods: Part 2

For this section, we will try and explore the emissions associated with commutes
from bedroom communities to job centers. The average commute distance to San
Francisco, as well as San Mateo and Santa Clara counties, is estimated and compared
to the commuting distance of residents of the three counties. Furthermore, 
the additional carbon emissions caused by the housing imbalance is estimated. 

The commute data contains the commute flows from every census tract to every other census
tract for the 14-county region, as well as their Euclidian distance. The original
dataset (over 4 million rows) has been filtered to only include trips that both
start and end within the 14-county region.

```{r}
bay_area_commutes <-
  read_csv(bay_area_commute_path)

glimpse(bay_area_commutes)

bay_area_commutes %>% slice(1:10)
```

We will use latitude and longitude of each census tract to match the tracts to each community.
Read in census tract data for the 14-county region.
```{r}
bay_area_tract_data <-
  read_csv(census_tracts_bay_area) %>% 
  select(GEOID, INTPTLAT, INTPTLONG, county_code, County)
```

```{r}
glimpse(bay_area_tract_data)
```

We are interested in visualizing the imbalance in commute patterns into and out of each county. First, let's find the total inflows and outflows into every census tract, as well as the weighted average distance travelled to each tract.

```{r}
# To find the inflows, group by DFIPS 
inflows <-
  bay_area_commutes %>% 
  mutate(total_trip_km = FLOW * LENKM) %>% 
  group_by(DFIPS) %>% 
  summarize(
    total_flow_to_tract = sum(FLOW),
    avg_km_to_tract = weighted.mean(LENKM, FLOW)
  )

# To find the outflows, group by OFIPS
outflows <-
  bay_area_commutes %>% 
  mutate(total_trip_km = FLOW * LENKM) %>% # note, this includes commutes that start and end in same tract!
  group_by(OFIPS) %>% 
  summarize(
    total_flow_from_tract = sum(FLOW),
    avg_km_from_tract = weighted.mean(LENKM, FLOW)
  )

# Finally, join together, rename to "TRACT", and join with county data
flow_data <-
  inflows %>% 
  left_join(outflows, by = c("DFIPS" = "OFIPS")) %>% 
  rename(tract = DFIPS) %>% 
  left_join(bay_area_tract_data, by = c("tract" = "GEOID")) 

flow_data

```

Let's also make a flow matrix (heat-map) for the 14-county region.
```{r}
flow_matrix <-
  bay_area_commutes %>% 
  left_join(bay_area_tract_data, by = c("OFIPS" = "GEOID")) %>% 
  rename(origin_lat = INTPTLAT, origin_lon = INTPTLONG, origin_county_code = county_code, origin_county = County) %>% 
  left_join(bay_area_tract_data, by = c("DFIPS" = "GEOID")) %>% 
  rename(dest_lat = INTPTLAT, dest_lon = INTPTLONG, dest_county_code = county_code, dest_county = County) %>% 
  group_by(origin_county, dest_county) %>% 
  summarize(flow = sum(FLOW),
            avg_length_km = weighted.mean(LENKM, FLOW)) 

flow_matrix
```

```{r, fig.height=11, fig.width=11}

my_breaks = c(10, 100, 1000, 10000, 100000, 1E6)
              
flow_matrix %>% 
  ggplot() +
  geom_tile(aes(x = origin_county, y = reorder(dest_county, desc(dest_county)), fill = flow)) +
  geom_text(aes(x = origin_county, y = reorder(dest_county, desc(dest_county)), label = flow)) +
  geom_text(aes(x = origin_county, y = reorder(dest_county, desc(dest_county)), label = round(avg_length_km, 1)), size = 2.5, color = "red", vjust = 2.2, fontface = "bold") +
  scale_fill_gradient(low = "white", high = "orange", trans = "log", breaks = my_breaks, labels = comma) +
  scale_x_discrete(position = "top") +
  coord_equal() +
  labs(
    x = "Origin County",
    y = "Destination County",
    fill = "Total Commute Flow"
  ) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 0, vjust = 1)
    )

```

```{r}
# Distribution of commute lengths, weighted by commute flow

mean_length <-
  bay_area_commutes %>% 
  summarize(
    mean_length = weighted.mean(LENKM, FLOW),
  )

median_length <-
  bay_area_commutes %>% 
  summarize(
    median_length = median(rep(LENKM, times = FLOW))
  )

bay_area_commutes %>% 
  ggplot(aes(x = LENKM, weight = FLOW)) +
  geom_histogram(binwidth = 3) +
  scale_y_continuous(
    breaks = seq(0, 600000, by = 100000),
    labels = scales::comma_format(accuracy = 1)
  ) +
  theme_bw() +
  labs(
    x = "Commute Distance [km]",
    y = "Number of Commuters",
    title = sprintf("Mean Commute Distance: %1$s km", round(mean_length, 1)),
    subtitle = sprintf("Median Commute Distance: %1$s km", round(median_length, 1)) 
  )

```

Next, let's observe the total inflows and outflows from each county. We can calculate the imbalance as well. A positive imbalance means more people commute to that county than from it. I'll refer to this as net inflow.

```{r}
flow_data %>% 
  group_by(County) %>% 
  summarize(total_flow_to_county = sum(total_flow_to_tract, na.rm = TRUE),
            total_flow_from_county = sum(total_flow_from_tract, na.rm = TRUE),
            avg_commute_to_county_km = weighted.mean(avg_km_to_tract, total_flow_to_tract, na.rm = TRUE),
            avg_commute_from_county_km = weighted.mean(avg_km_from_tract, total_flow_from_tract, na.rm = TRUE)
            ) %>% 
  mutate(imbalance = total_flow_to_county - total_flow_from_county)
```

The average distances calculated above include commutes within a single county. Since we are interested in estimating the emissions associated with commute imbalances, let's remove commutes that start and end within the same county and compare the distances.
```{r}
flow_matrix_detailed <-
  bay_area_commutes %>% 
  left_join(bay_area_tract_data, by = c("OFIPS" = "GEOID")) %>% 
  rename(origin_lat = INTPTLAT, origin_lon = INTPTLONG, origin_county_code = county_code, origin_county = County) %>% 
  left_join(bay_area_tract_data, by = c("DFIPS" = "GEOID")) %>% 
  rename(dest_lat = INTPTLAT, dest_lon = INTPTLONG, dest_county_code = county_code, dest_county = County) 

inter_county_dest <-
  flow_matrix_detailed %>% 
  filter(dest_county != origin_county) %>% 
  group_by(dest_county) %>% 
  summarize(
    total_flow_into_county = sum(FLOW, na.rm = TRUE),
    avg_commute_to_county_km = weighted.mean(LENKM, FLOW, na.rm = TRUE)
  )

flow_matrix_detailed
```

Let's also look at the commutes from each county
```{r}
inter_county_orig <-
  flow_matrix_detailed %>% 
  filter(dest_county != origin_county) %>% 
  group_by(origin_county) %>%
  summarize(
    total_flow_leaving_county = sum(FLOW, na.rm = TRUE),
    avg_commute_from_county_km = weighted.mean(LENKM, FLOW, na.rm = TRUE)
  )
```

```{r}
flows_inter_county <-
  inter_county_dest %>% 
  left_join(inter_county_orig, by=c("dest_county" = "origin_county"))

flows_inter_county
```
Let's plot the commute length distribution for inter-county commutes
```{r}
mean_distance_inter_county <-
  flow_matrix_detailed %>% 
  filter(origin_county != dest_county) %>% 
  summarize(
    distance = weighted.mean(LENKM, FLOW)
  )

median_distance_inter_county <-
  flow_matrix_detailed %>% 
  filter(origin_county != dest_county) %>% 
  summarize(
    median_length = median(rep(LENKM, times = FLOW))
  )

flow_matrix_detailed %>% 
  filter(origin_county != dest_county) %>% 
  ggplot(aes(x = LENKM, weight = FLOW)) +
  geom_histogram(binwidth = 3) +
  scale_y_continuous(
    breaks = seq(0, 100000, by = 10000),
    labels = scales::comma_format(accuracy = 1)
  ) +
  theme_bw() +
  labs(
    x = "Commute Distance [km]",
    y = "Number of Commuters",
    title = sprintf("Mean Commute Distance: %1$s km", round(mean_distance_inter_county, 1)),
    subtitle = sprintf("Median Commute Distance: %1$s km", round(median_distance_inter_county, 1)) 
  )

```


San Francisco has the highest net inflow, at 153,600 commutes, followed by Santa Clara County, with 89,627 commutes. On the opposite end of the spectrum, Contra Costa County has the highest outflow, with 98,405 more commutes begining than ending in the County each day. Solano, San Joaquin, Sonoma, Stanislaus, and Santa Cruz Counties all have significant outflows of commuters. The value for Santa Clara is similar to that reported by SV @ Home (~100k).

# Assigning Emissions Impacts to Communities
For this study, I will assign the emissions impact to the counties / communities with a net inflow of commuters. This implies that jobs cannot be simply relocated to other cities, but rather that job-rich, wealthy communities need to do more to tackle the emissions associated with commutes into their city. Furthermore, job-rich communities often have the highest GHG reduction targets in their climate action plans. I want to make sure that they are not excluding the emissions associated with these commutes.


```{r, fig.height = 10}
csa_cities_cleaned %>% 
  ggplot() +
  geom_sf() + 
  geom_sf(data = flow_data %>% st_as_sf(coords = c("INTPTLONG", "INTPTLAT"), crs = 4326), size = 0.1, color="red") +
  theme_bw()

```

Let's join the flow data with the csa_cities_data. To ensure I account for all flows I will use the st_nearest feature to identify the closest community to each census tract centerpoint.


```{r}

csa_cities_cleaned_idx <-
  csa_cities_cleaned %>% 
  mutate(index = row_number())

csa_cities_cleaned_idx
flow_data_idx <-
  flow_data %>% 
  mutate(index = st_nearest_feature(flow_data %>% st_as_sf(coords = c("INTPTLONG", "INTPTLAT"), crs = 4326), csa_cities_cleaned %>% st_as_sf))

flow_data_idx

flow_by_csa_city <-
  csa_cities_cleaned_idx %>% 
  left_join(flow_data_idx, by = "index")

flow_by_csa_city
```


```{r}
# New version, use flow_matrix_detailed! 
csa_cities_cleaned_idx <-
  csa_cities_cleaned %>% 
  mutate(index = row_number())

# running this next chunk takes a long time (2 mins ish)
# find the origin and destination city index for each tract
flow_data_origin_city <-
  flow_matrix_detailed %>% 
  mutate(origin_index = st_nearest_feature(flow_matrix_detailed %>%  st_as_sf(coords = c("origin_lon", "origin_lat"), crs = 4326), csa_cities_cleaned %>% st_as_sf)) %>% 
  mutate(dest_index = st_nearest_feature(flow_matrix_detailed %>%  st_as_sf(coords = c("dest_lon", "dest_lat"), crs = 4326), csa_cities_cleaned %>% st_as_sf))

flow_by_csa_city_detailed <-
  csa_cities_cleaned_idx %>% 
  rename(origin_city = NAME) %>% 
  select(origin_city, index) %>% 
  # join city data with flow data to get the origin city name
  left_join(flow_data_origin_city, by = c("index" = "origin_index")) %>% 
  # join the flow data with city data to get destination city name
  left_join(csa_cities_cleaned_idx %>% rename(dest_city = NAME) %>% select(dest_city, index) %>% st_drop_geometry(), by = c("dest_index" = "index"))

flow_by_csa_city_detailed
```


```{r}


flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(origin_city != dest_city) %>% 
  summarize(flow_total = sum(FLOW, na.rm = TRUE))

```

Now, we can see the imbalance by city! To ensure I account for all flows I will use the st_nearest feature to identify the closest community to each census tract centerpoint.

Emissions Per Mile and Driving Mode Share
```{r}
emissions_tibble = tribble(
  ~County, ~emis_factor_lb_per_km,
  "Alameda", 0.30,
  "Contra Costa", 0.34,
  "Marin", 0.34,
  "Napa", 0.36,
  "San Francisco", 0.17,
  "San Mateo", 0.35,
  "Santa Clara", 0.37,
  "Solano", 0.39,
  "Sonoma", 0.38,
  "Stanislaus", 0.4,
  "Merced", 0.4,
  "San Joaquin", 0.4,
  "Santa Cruz", 0.4,
  "San Benito", 0.4
)
emissions_tibble
```

For calculating the imbalance by city (and emissions), we can drop commutes that start and end in the same city (won't contribute to imbalance )
```{r}
flow_by_csa_city_detailed

commute_flow_into_city <-
  flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(origin_city != dest_city) %>% 
  # group by community
  left_join(emissions_tibble, by = c("origin_county" = "County")) %>% 
  group_by(dest_city) %>% 
  summarize(
    flow_into_city = sum(FLOW, na.rm = TRUE),
    commute_to_city_km = weighted.mean(LENKM, FLOW, na.rm = TRUE),
    emissions_lb_per_km = weighted.mean(emis_factor_lb_per_km, FLOW, na.rm = TRUE)
  ) 

commute_flow_leaving_city <-
  flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(origin_city != dest_city) %>% 
  group_by(origin_city) %>% 
  summarize(
    flow_leaving_city = sum(FLOW, na.rm = TRUE),
    commute_leaving_city_km = weighted.mean(LENKM, FLOW, na.rm = TRUE),
  )

imbalance_and_emissions_city <-
  commute_flow_into_city %>% 
  left_join(commute_flow_leaving_city, by = c("dest_city" = "origin_city")) %>% 
  rename(city = dest_city) %>% 
  mutate(
    imbalance = flow_into_city - flow_leaving_city, 
    daily_commute_emissions_lb = commute_to_city_km * emissions_lb_per_km * imbalance * 2, 
    annual_commute_emissions_lb = daily_commute_emissions_lb * 5 * 48  # assume 4 weeks off per year, and 5 days per workweek
  ) 

commute_flow_into_city
commute_flow_leaving_city
imbalance_and_emissions_city
``` 

Let's make the same distribution plot as we did for commute lengths and commute lengths that are inter-county but only for commutes that cross city boundaries. We expect the mean and median distribution to be somewhere in between the previous values.
```{r}
mean_distance_inter_city <-
  flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(origin_city != dest_city) %>% 
  summarize(
    distance = weighted.mean(LENKM, FLOW)
  )

median_distance_inter_city <-
  flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(origin_city != dest_city) %>% 
  summarize(
    median_length = median(rep(LENKM, times = FLOW))
  )

flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(origin_city != dest_city) %>% 
  ggplot(aes(x = LENKM, weight = FLOW)) +
  geom_histogram(binwidth = 3) +
  scale_y_continuous(
    breaks = seq(0, 250000, by = 50000),
    labels = scales::comma_format(accuracy = 1)
  ) +
  theme_bw() +
  labs(
    x = "Commute Distance [km]",
    y = "Number of Commuters",
    title = sprintf("Mean Commute Distance: %1$s km", round(mean_distance_inter_city, 1)),
    subtitle = sprintf("Median Commute Distance: %1$s km", round(median_distance_inter_city, 1)) 
  )
```

Let's graph the commute imbalance versus the housing deficit for each city that we calculated previously. SF is excluded from the figure - otherwise, it would be impossible to distinguish most of the other communities.

```{r}
deficit_imbalance <-
  deficit %>% st_drop_geometry() %>% 
  left_join(imbalance_and_emissions_city, by = c("name" = "city")) %>% 
  filter(name != "San Francisco") 

ggplot(deficit_imbalance) +
  geom_point(aes(x = housing_deficit, y = imbalance)) +
  geom_text_repel(data = deficit_imbalance %>% filter(name %in% c("Santa Clara", "Stanford", "Berkeley", "San Jose", "Palo Alto", "Pleasanton", "Mountain View")),
                  aes(label = name, x = housing_deficit, y = imbalance), vjust="inward", nudge_y = 1000, nudge_x = -800) +
  theme_bw() +
  coord_cartesian(xlim = c(-21000, 63000)) +
  labs(
    x = "Housing Deficit",
    y = "Net Commute Inflow"
  )
``` 

# Emissions Estimate

```{r}
flow_by_csa_city_detailed %>% st_drop_geometry() %>% 
  filter(dest_city == "San Francisco") %>% 
  summarize(sum = sum(FLOW))
```

Less Simplified Version 

```{r}
imbalance_and_emissions_city %>% 
  filter(annual_commute_emissions_lb > 0) %>% 
  summarize(annual_emissions_lb = sum(annual_commute_emissions_lb)) %>% 
  mutate(annual_emissions_mt = annual_emissions_lb / 2204.6) 

```

Worst Cities 
```{r}
imbalance_and_emissions_city %>% 
  filter(annual_commute_emissions_lb > 0) %>% 
  mutate(annual_emissions_mt = annual_commute_emissions_lb / 2204.6) %>% 
  arrange(-annual_emissions_mt) 

```

Total Imbalance from Job-Rich communities
```{r}
imbalance_and_emissions_city %>% 
  filter(annual_commute_emissions_lb > 0) %>% 
  summarize(total_imbalance = sum(imbalance))
```


```{r, fig.height = 10, fig.width = 10}
NYT_DEM <- "#1A80C4"
NYT_REP <- "#CC3D41"
light_blue <- "#bfefff"
light_red <- "#FDB8A9"
dark_red <- "#9C2A12"


city_jobs_imbalance <-
  st_intersection(csa_counties, csa_cities %>% st_transform(crs = 4326)) %>% 
  left_join(imbalance_and_emissions_city, by = c("NAME" = "city"))


deficit %>% 
  ggplot() +
  geom_sf(aes(fill = NULL), data = csa_counties) +
  geom_sf(aes(fill = NULL), color = "black", data = city_jobs_imbalance) +
  geom_sf(aes(fill = imbalance), data = city_jobs_imbalance) +
  coord_sf(ylim = c(36.75, 38.5),
           xlim = c(-120.7, -122.7)) +
  scale_fill_gradientn(
    labels = scales::comma_format(accuracy = 1, suffix = " jobs"),
    colors = c(NYT_DEM, light_blue, "white", NYT_REP, dark_red),
    values = c(-10000, -1000, 5000, 50000, 100000) %>%
      scales::rescale()
  ) +
  theme_minimal() +
  labs(
    fill = "Job Imbalance",
    title = "San Francisco's job imbalance is by far the largest contributor to the region's housing shortage",
    subtitle = "Outside of SF, Silicon Valley communities tend to have the largest job imbalances"
  )

```


OLD CODE

I will take a simplified approach at estimating the emissions. I will assign an emissions per kilometer to each census tract, based on the county the tract lies within. The emissions estimate will be based on an average vehicle MPG (assumed to be the same for all counties), and the percentage of people within each county that commute by single-occupancy car.


```{r}
flow_by_csa_city %>%  
  ggplot() +
  geom_sf()

flow_data %>% 
  mutate(index = st_nearest_feature(flow_data %>% st_as_sf(coords = c("INTPTLONG", "INTPTLAT"), crs = 4326), csa_cities_cleaned %>% st_as_sf))

```



**Emissions Impact of Adding Housing near Jobs**

A 2006 Bay Area study found that a 10% increase of jobs within 4 miles of a 
residence reduces vehicle miles traveled (VMT) by approximately 3% (Cervero & Duncan).

If this report is accurate, then, somewhat counterintuitively, Palo Alto could 
drastically increase its supply of housing and still reduce its total VMT. 
If implemented in tandem with improvements to bus, Caltrain, and bike infrastructure,
local traffic could also be mitigated.

**Other Counties**
We can repeat our Santa Clara County analysis for San Francisco and San Mateo 
counties.


We can also clearly see the Central Valley supercommuters in the San Francisco dataset.

## Results & Discussion

This report attempted to use various spatial datasets, census data, and Metropolitan Transportation
Commission data to match housing units and jobs with each city in the San Francisco Bay Area.
The goal of this data analysis was to estimate the magnitude of the deficit of 
housing units in the region and to identify which cities have contributed the most
to the shortage. Furthermore, using census data on the origin and destination of
commutes between census tracts, the existence of supercommutes to the Bay Area
from the Central Valley was confirmed. Finally, for each city in Santa Clara and
San Mateo counties, as well as the city of San Francisco, the net influx of commuters,
approximate commute VMT, and carbon dioxide emissions attributable to the mismatch
between jobs and housing units was estimated. 

The data shows that, assuming an optimal ratio of 1.25 jobs per housing unit,
the Bay Area must build over 300,000 housing units just to catch up to 2015
employment levels. The data also suggests that cities with a high amount of jobs
per resident are causing millions of extra miles of vehicle travel each day,
which in turn has led to increased transportation emissions.

If we are serious about tackling our carbon footprint, reducing inequality, and
improving quality of life, we must address the systemic issues which led to our current
housing predicament. 



## References
[^1]: https://www.latimes.com/local/lanow/la-me-adv-california-climate-pollution-20180722-story.html
[^2]: https://medium.com/@robertspragg/decarbonization-and-density-go-hand-in-hand-a264ea358793 
[^3]: https://www.ppic.org/wp-content/uploads/r-118hjr.pdf 
[^4]: https://en.wikipedia.org/wiki/San_Jose%E2%80%93San_Francisco%E2%80%93Oakland,_CA_Combined_Statistical_Area 
[^5]: http://opendata.mtc.ca.gov/datasets/transportation-analysis-zones 
[^6]: https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0166083#sec003 
[^7]: https://siliconvalleyathome.org/map_type/cities-public-agencies/ 
[^8]: https://earthworks.stanford.edu/ 
[^9]: https://sf.curbed.com/2017/7/26/16040938/san-francisco-jobs-housing-ratio-homes 
[^10]: https://www.vitalsigns.mtc.ca.gov/commute-mode-choice 
[^11]: https://data.acgov.org/County-Government/Alameda-County-US-Census-Tracts-2010/v5tf-3bdj 
[^12]: http://2040.planbayarea.org/sites/default/files/2017-07/Plan%20Bay%20Area%202040_Adopted_07.26.17.pdf 
[^13]: https://siliconvalleyathome.org/resource-map/jobs-and-housing/ 
[^14]: https://www.epa.gov/greenvehicles/greenhouse-gas-emissions-typical-passenger-vehicle 

## Appendix
